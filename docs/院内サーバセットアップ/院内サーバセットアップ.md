# 院内サーバセットアップ手順

<div style="text-align: right;">
    <font color="silver">
        更新日：2021/07/16　tak)waki
    </font>
</div>

## クラウド版カルテを利用するまでの流れ
クラウド版カルテを利用する際は、以下の順に作業を行い利用開始してください
```
　[導入] 施設コードの申請
　　　　　↓
　[開発] クラウド情報の払出し
  　　　　↓
　[開発] クラウド環境作成
　　  　　↓
　[導入] 院内NASのセットアップ
　　　　　↓
　[導入] 院内サーバのセットアップ
　　　　　↓
　[導入] 院内クライアントのセットアップ
```

## 施設コードの申請
クラウド版電子カルテを利用する施設は申請をいただくことで以下の情報を払い出します  
※申請先は今の所`「村松・大脇」`としています

- クラウド用グループコード
- クラウド用施設コード
- ライセンスコード
- クラウド接続用の証明書

## 院内サーバセットアップ資源
格納場所
```
\\192.168.61.23\share300\303_ＨＣシ事シスソリＢＵ\01_利用者限定\25 カルテT\10 共通\90_セットアップ\SVセットアップ\クラウド院内SV\01_院内サーバインストーラー
```
セットアップ対象端末のデスクトップにフォルダごとコピーして利用してください
```
C:\Users\KarteUser\Desktop\01_院内サーバインストーラー
```


## 院内NASのセットアップ
### NAS本体の構築

以下の手順を元にNAS本体にHDDを装着します

| 画像                                         | 説明                                                                                  |
| -------------------------------------------- | ------------------------------------------------------------------------------------- |
| <img width="200" alt="" src="img/nas-1.png"> | 本体を取り出し、正面のカバーを引っ張り外します                                        |
| <img width="200" alt="" src="img/nas-2.png"> | `「Push」`ボタンを押しながらHDDマウントケースを取出します                             |
| <img width="200" alt="" src="img/nas-3.png"> | HDDマウントケースの側面にあるロックを外します                                         |
| <img width="200" alt="" src="img/nas-4.png"> | HDDを装着し、HDDマウントケース側面のロックを付けます                                  |
| <img width="200" alt="" src="img/nas-5.png"> | HDDマウントケースを本体に戻します。「`▲UP`」を目印にし、上下をあわせてください        |
| <img width="200" alt="" src="img/nas-6.png"> | 本体背面の`「LAN1」`にインターネットに接続できるLANを接続し、電源ゲーブルも接続します |
| <img width="200" alt="" src="img/nas-7.png"> | 本体前面のカバーを戻し、電源ボタンを押下します                                        |

### NASの初期セットアップ
NASセットアップURLを起動します  
```
01_院内サーバインストーラー
├─@NAS
│  │- NASセットアップURL.url
```

`接続`をクリックします  
<img width="400" alt="" src="img/nas-setting-1.png">

`私はEULAの条件を読み、これに同意します`にチェックを入れ、`次へ`をクリックします  
<img width="400" alt="" src="img/nas-setting-2.png">

`続行`をクリックします  
<img width="400" alt="" src="img/nas-setting-3.png">

`設定`をクリックします  
<img width="400" alt="" src="img/nas-setting-4.png">

`今すぐインストール`をクリックします  
<img width="400" alt="" src="img/nas-setting-5.png">

`これらのハードディスクに保管されているすべてのデータが削除されることを理解しました`にチェックを入れ、`OK`をクリックします  
<img width="400" alt="" src="img/nas-setting-6.png">

インストールが完了し、再起動が完了するまで待機します(10分ほど)  
<img width="400" alt="" src="img/nas-setting-7.png">
<img width="400" alt="" src="img/nas-setting-8.png">

管理者アカウント情報を入力して`次へ`をクリックします  
  - サーバ名：TAKNAS
  - ユーザ名：KarteUser
  - パスワード：AppUser00

<img width="400" alt="" src="img/nas-setting-9.png">

Synologyアカウントにログインし、QuickConnectIDを設定後、`次へ`をクリックします  

<img width="400" alt="" src="img/nas-setting-10.png">

  1. `アカウントを作成するか、またはサインインします`で`サインイン`をクリックします  
      ユーザID：tak-karte_support@taknet.co.jp  
      パスワード：Tak756532!  

<img width="400" alt="" src="img/nas-setting-11.png">

  2. QuickConnectIDを入力します  
      QuickConnectID：TAKNAS%クラウド用施設コード%  
        例）クラウド用施設コード：00010  
        　　QuickConnectID：TAKNAS00010  

<img width="400" alt="" src="img/nas-setting-12.png">

NAS管理画面へのショートカットをデスクトップへコピーし、`次へ`をクリックします  
`私をデスクトップにドラッグしてください`に従ってください  
<img width="400" alt="" src="img/nas-setting-13.png">

`移動`をクリックします  
<img width="400" alt="" src="img/nas-setting-14.png">

`了解`をクリックします  
<img width="400" alt="" src="img/nas-setting-15.png">

`あり`をクリックします  
<img width="400" alt="" src="img/nas-setting-16.png">

`私はデバイス分析のプライバシーに関する声明を承諾しました`にチェックを行い、`OK`をクリックします  
<img width="400" alt="" src="img/nas-setting-17.png">

ツアーに従い指定された箇所をクリックしてします  
<img width="700" alt="" src="img/nas-setting-18.png">

`私はデバイス分析のプライバシーに関する声明を承諾しました`にチェックを行い、`OK`をクリックします  
<img width="400" alt="" src="img/nas-setting-17.png">


### NASのRAID設定
#### ストレージプールの作成

ストレージマネージャ画面を起動します  
> NAS管理画面 > メニュー > ストレージマネージャ > ストレージプール  
> <img width="100" alt="" src="img/nas-setting-menu.png">

`作成`をクリックします  
<img width="400" alt="" src="img/nas-raid-1.png">

`より高い柔軟性`を選択し、`次へ`をクリックします  
<img width="400" alt="" src="img/nas-raid-2.png">

`RAIDタイプ`を`RAID1`に変更し、`次へ`をクリックします  
<img width="400" alt="" src="img/nas-raid-3.png">

ディスクを全て選択し、`次へ`をクリックします  
<img width="400" alt="" src="img/nas-raid-4.png">

警告が表示された場合は`続行`をクリックします  
<img width="400" alt="" src="img/nas-raid-5.png">

`OK`をクリックします  
<img width="400" alt="" src="img/nas-raid-6.png">

`いいえ`を選択し、`次へ`をクリックします  
<img width="400" alt="" src="img/nas-raid-7.png">

`適用`をクリックします  
<img width="400" alt="" src="img/nas-raid-8.png">

`OK`をクリックします  
<img width="400" alt="" src="img/nas-raid-9.png">


#### ボリュームの作成
ストレージマネージャから`ボリューム`を選択します  
> NAS管理画面 > メニュー > ストレージマネージャ > ボリューム

`作成`をクリックします  
<img width="400" alt="" src="img/nas-raid-vol-1.png">

`カスタマイズ`を選択し、`次へ`をクリックします  
<img width="400" alt="" src="img/nas-raid-vol-2.png">

`既存のストレージプールを選択`を選択し、`次へ`をクリックします  
<img width="400" alt="" src="img/nas-raid-vol-3.png">

`次へ`をクリックします  
<img width="400" alt="" src="img/nas-raid-vol-4.png">

`Btrfs`を選択し、`次へ`をクリックします  
<img width="400" alt="" src="img/nas-raid-vol-5.png">

`次へ`をクリックします  
<img width="400" alt="" src="img/nas-raid-vol-6.png">

`適用`をクリックします  
<img width="400" alt="" src="img/nas-raid-vol-7.png">

ボリューム作成が完了するまでしばらく待機します  
<img width="400" alt="" src="img/nas-raid-vol-8.png">

`正常`と表示されれば完了です  
<img width="400" alt="" src="img/nas-raid-vol-9.png">


### NASの設定を復元
初期設定値を設定ファイルから復元します  

コントロールパネルから`更新と復元`を選択します  
> NAS管理画面 > コントロールパネル > 更新と復元 > 設定のバックアップ  

コンフィグレーションの復元をクリックします  
<img width="400" alt="" src="img/nas-repair-1.png">

NAS初期値設定ファイルを選択し、`OK`をクリックします  
```
01_院内サーバインストーラー
├─@NAS
│  ├─設定ファイル
│  │    │- NASSetting.dss
```
<img width="400" alt="" src="img/nas-repair-2.png">

`上書き競合設定`と`全システムの構成`にチェックを入れ、`OK`をクリックします  
<img width="400" alt="" src="img/nas-repair-3.png">

`はい`をクリックします  
<img width="400" alt="" src="img/nas-repair-4.png">


### 時刻の設定
タイムゾーンと時刻同期の設定を行います  

コントロールパネルから`地域のオプション`を選択します  
> NAS管理画面 > コントロールパネル(上級者モード) > 地域のオプション  

`時刻`ページの設定を以下のように変更し、`適用`をクリックします
  - タイムゾーンを`(GMT+09:00) Tokyo, Osaka, Sapporo`に変更します
  - 時刻設定を`NTPサーバとの同期`に変更します
  - サーバアドレスに`ntp.nict.jp`を入力します
  - `今すぐアップデートする`をクリックし、時刻同期を実施します

<img width="400" alt="" src="img/nas-time-1.png">

`NTP機能`ページの設定を以下のように変更し、`適用`をクリックします  
 - `NTPサービスを有効にする`にチェックをいれます

<img width="400" alt="" src="img/nas-time-2.png">


### メール通知の設定
NAS故障時にメール通知が行われるように設定を行います  

コントロールパネルから`通知`を選択します  
> NAS管理画面 > コントロールパネル(上級者モード) > 通知

`電子メール`ページの設定を以下のように変更し、`適用`をクリックします  
  - 電子メール通知を有効にするにチェックを入れる
  - 受信者のEメールアドレス：`tak-karte_alert@taknet.co.jp`
  - 対象接頭辞：`taknas%クラウド用施設コード%-%施設名%`
        例）クラウド用施設コード：00010  
        　　施設名：タッククリニック
        　　対象接頭辞：taknas00010-タッククリニック  
  - サービスプロバイダ：`Outlook`
  - ユーザ名：`tak-karte@outlook.jp`
  - パスワード：`Tak756532!`

`適用`ボタンクリック後に`テストメールの送信`をクリックします
> 認証メールの受信確認は`村松・大脇`にて実施を行いますので、声をかけてください    
> テストメール送信時にOutlookの認証エラーで送信エラーが発生する可能性があります  
> その際は`村松・大脇`にて認証処理を行いますので、声をかけてください  

<img width="400" alt="" src="img/nas-mail-1.png">
<img width="400" alt="" src="img/nas-mail-2.png">


### DDNSの設定
NASにDDNSの設定を行い、生存確認を行えるようにします

コントロールパネルから`外部アクセス`を選択します  
> NAS管理画面 > コントロールパネル(上級者モード) > 外部アクセス

`DDNS`ページを開き、`追加`ボタンをクリックします  
<img width="400" alt="" src="img/nas-ddns-1.png">

`DDNS`ページの設定を以下ようにに変更し、`OK`ボタンをクリックします  
  - サービスプロバイダー：`Synology`
  - ホスト名：`TAKNAS-%クラウド用施設コード%`  
        例）クラウド用施設コード：00010  
        　　ホスト名：TAKNAS-00010  
  - Heartbeat：有効  

<img width="400" alt="" src="img/nas-ddns-2.png">

証明書の確認が表示されますので、`はい`をクリックします  
<img width="400" alt="" src="img/nas-ddns-3.png">


### WOLの設定
NASの電源をリモートでONにする設定を行います  

コントロールパネルから`ハードウェアと電源`を選択します  
> NAS管理画面 > コントロールパネル(上級者モード) > ハードウェアと電源

`全般`ページの設定を以下のように変更し、`適用`をクリックします  
  - 電源復旧欄の`電源の問題が修正されたときに自動的に再起動する`にチェックを入れる
  - 電源復旧欄の`WOL on LAN 1を有効にする`にチェックを入れる

WOLはIPアドレスとMACアドレスを使用してリモートで電源を入れる仕組みです  
パソコンにも同じ仕組みが用意されていますので、使いたい方はネットで調べてください  

<img width="400" alt="" src="img/nas-hardware-1.png">


### IPアドレスの設定
現地のIPアドレスを設定します  

コントロールパネルから`ネットワーク`を選択します  
> NAS管理画面 > コントロールパネル(上級者モード) > ネットワーク

  - `ネットワークインターフェース`ページを開き`LAN 1`を選択します
  - `編集`をクリックします
  - `手動で設定する`を選択し、現地の設定を入力する
  - `OK`をクリックします

<img width="400" alt="" src="img/nas-net-1.png">
<img width="400" alt="" src="img/nas-net-2.png">


### 監視ソフトのインストール資源をアップロード
院内サーバを監視するソフトをインストール資源をアップロードします  

`File Station`画面をを起動します  
> NAS管理画面 > メニュー > File Station

画面左部のツリーから`docker`を選択します  
インストール資源の`docker設定ファイル`フォルダ内のフォルダ・ファイルを`docker`へドラッグドロップでアップロードします  
```
01_院内サーバインストーラー
├─@NAS
│  ├─docker設定ファイル
│  │    ├─zabbix
│  │    │   ├─usr
│  │    │   │  │- ...
│  │    │   ├─var
│  │    │   │  │- ...
│  │    │- zabbix-agent2.json
│  │    │- zabbix-proxy.json
```
<img width="700" alt="" src="img/nas-docker-copy-1.png">

アップロード時に上書き確認が表示されますので`上書き`を選択  
<img width="400" alt="" src="img/nas-docker-copy-2.png">

zabbixフォルダの権限を変更する為、zabbixフォルダを選択し、`操作 > プロパティ`を選択します  
<img width="400" alt="" src="img/nas-docker-copy-3.png">

`許可`ページを開き、`詳細オプション > 継承権限を明確にする`を選択します  
<img width="400" alt="" src="img/nas-docker-copy-4.png">

ユーザ内から`Everyone`を選択し`編集`をクリックします  
<img width="400" alt="" src="img/nas-docker-copy-5.png">

`Everyone`を`読込み/書込み`に変更し`OK`をクリックします  
<img width="400" alt="" src="img/nas-docker-copy-6.png">
<img width="400" alt="" src="img/nas-docker-copy-7.png">


### 監視ソフトのインストール
院内サーバを監視するソフトを実行するソフトをダウンロードします  

`パッケージセンター`画面をを起動します  
> NAS管理画面 > パッケージセンター

`私はパッケージセンターのサービス規約を読み、これに同意します`にチェックを入れ、`OK`をクリックします  
<img width="400" alt="" src="img/nas-docker-1.png">

検索ボックスに`docker`と入力し、`Docker`をインストールした後、`Docker`を開きます  
<img width="400" alt="" src="img/nas-docker-2.png">
<img width="400" alt="" src="img/nas-docker-3.png">

`今後このメッセージを表示しない`にチェックを付け、`×`で閉じる  
<img width="400" alt="" src="img/nas-docker-4.png">

レジストリメニューを開き、検索ボックスに`zabbix-proxy-sqlite`と入力し、`zabbix/zabbix-proxy-sqlite3`をダブルクリックする  
<img width="400" alt="" src="img/nas-docker-5.png">

タグの選択で`5.4-alpine-latest`を選択し、`選択`をクリックする  
<img width="400" alt="" src="img/nas-docker-6.png">

検索ボックスに`zabbix-agent2`と入力し、`zabbix/zabbix-agent2`をダブルクリックする  
<img width="400" alt="" src="img/nas-docker-7.png">

タグの選択で`5.4-alpine-latest`を選択し、`選択`をクリックする  
<img width="400" alt="" src="img/nas-docker-8.png">

コンテナメニューを開き、`設定 > インポート`をクリックする  
<img width="400" alt="" src="img/nas-docker-9.png">

`zabbix-proxy.json`を選択し、`選択`をクリックする  
<img width="400" alt="" src="img/nas-docker-10.png">

コンテナ名に`zabbix-proxy`と入力し、`OK`をクリックする  
<img width="400" alt="" src="img/nas-docker-11.png">

コンテナメニューを開き、`設定 > インポート`をクリックする  
<img width="400" alt="" src="img/nas-docker-12.png">

`zabbix-agent2.json`を選択し、`選択`をクリックする  
<img width="400" alt="" src="img/nas-docker-13.png">

コンテナ名に`zabbix-agent2`と入力し、`OK`をクリックする  
<img width="400" alt="" src="img/nas-docker-14.png">

コンテナ一覧から`zabbix-proxy`を選択し、`編集`をクリックする  
<img width="400" alt="" src="img/nas-docker-15.png">

`環境`ページを選択し、`ZBX_HOSTNAME`の値を`TAKNAS%クラウド施設用コード%`に修正後、`適用`をクリック  
例）クラウド用施設コード：00010  
　　ZBX_HOSTNAME：TAKNAS00010  
<img width="400" alt="" src="img/nas-docker-16.png">

コンテナを全て起動する  
<img width="400" alt="" src="img/nas-docker-17.png">


## 院内サーバのセットアップ

注意事項  
 - 端末がインターネットに接続できる状態でセットアップを行ってください  
 - セットアップ後のIPでNASと通信が可能なLANでセットアップを行ってください  


### インストーラーの実行
クラウド接続用の証明書をインストーラー内に配置してください
> 証明書の名称は施設によって異なります
```
01_院内サーバインストーラー
│- takvpn001_1.p12
```

院内サーバのインストーラーを実行します
```
01_院内サーバインストーラー
│- SetupTerminalInfoSV.exe

```
サーバ情報の入力画面が表示されますので、現地設定を入力し、`確定`をクリックします  

| 区分                   | 項目                   | 説明                                                                   |
| :--------------------- | :--------------------- | :--------------------------------------------------------------------- |
| クラウド設定           | クラウドグループ       | クラウド用グループコード                                               |
|                        | 施設コード             | クラウド用施設コード                                                   |
| 院内ネットワーク設定   | アダプタ               | 有線LANのアダプタ名を選択                                              |
|                        | IPアドレス(メイン)     | メインサーバのIPアドレスを入力  (レプリカサーバのセットアップ時も必要) |
|                        | IPアドレス(レプリカ)   | レプリカサーバのIPアドレスを入力  (メインサーバのセットアップ時も必要) |
|                        | サブネット             | サブネットマスクを入力                                                 |
|                        | デフォルトゲートウェイ | デフォルトゲートウェイを指定  (未使用の場合は未入力)                   |
|                        | DNS                    | DNSサーバのIPアドレスを入力  (セカンダリを未使用の場合は未入力)        |
| その他ネットワーク設定 | NAS IPアドレス         | NASのIPアドレスを入力                                                  |

<img width="300" alt="" src="img/sv-1.png">　<img width="300" alt="" src="img/sv-2.png">

セットアップ情報の確認とサーバ種別の選択画面が表示されますので、画面に従い`メインサーバ`か`レプリカサーバ`かを入力します  
<img width="300" alt="" src="img/sv-3.png">

１時間程で下記の画面となり、セットアップが完了します  
> セットアップ中は複数回再起動が行われます  

<img width="300" alt="" src="img/sv-4.png">


### 共有フォルダのパスワード保護を無効化
共有の詳細設定を開きます
> コントロール パネル > ネットワークとインターネット > ネットワークと共有センター > 共有の詳細設定

`パスワード保護共有を無効にする`を選択し、`変更の保存`をクリックします

<img width="300" alt="" src="img/sv-share-1.png">



